<!DOCTYPE html>
<html>
<head>
    <title>Test: &lt;link&gt; onload & onerror</title>
</head>
<body>
<textarea id="logs" style="width:100%;height:500px;" autocomplete="off"></textarea>
<script>
    var insertPoint = firstNodeOfTagName('head') || firstNodeOfTagName('script'),
        testElement = document.createElement('link'),
        logElement = document.getElementById('logs');

    function log(message){
        logElement.value += message + '\n';
    }
    function firstNodeOfTagName(name){
        return document.getElementsByTagName(name)[0];
    }
    function create(url){
        var link = document.createElement('link');

        // events handlers
        link.onload = function(){
            log('onload: ' + link.href);

        };
        link.onerror = function(){
            log('onerror: ' + link.href);
        };

        // attributes
        link.rel  = 'stylesheet';
        link.type = 'text/css';
        link.href = url;

        // adds to dom tree
        insertPoint.appendChild(link);
    }

    log(new Date - 0);

//    log("create, has 'onload': " + ('onload' in testElement));
//    log("create, has 'onerror': " + ('onerror' in testElement));
//    testElement.rel  = 'stylesheet';
//    testElement.type = 'text/css';
//    testElement.href = 'qunit/qunit.css';
//    log("attrs, has 'onload': " + ('onload' in testElement));
//    log("attrs, has 'onerror': " + ('onerror' in testElement));
//    insertPoint.appendChild(testElement);
//    log("insert, has 'onload': " + ('onload' in testElement));
//    log("insert, has 'onerror': " + ('onerror' in testElement));
//
//    create('style.php');
//    create('non-existent.css');
//    create('http://static.jquery.com/files/rocker/css/reset.css');
//    create('http://static.jquery.com/files/rocker/css/none.css');

    /* desktop
     * ie-7~9:   T T T T T T | 4 onload 0 onerror
     * ff-2~8:   F F F F F F | 0 onload 0 onerror
     * ff-9~15:  T T T T T T | 2 onload 2 onerror
     * ch-16~17: T T T T T T | 0 onload 0 onerror
     * ch-19~21: T T T T T T | 2 onload 2 onerror
     * sf-5.1.7: T T T T T T | 0 onload 0 onerror
     * sf-6:     T T T T T T | 2 onload 2 onerror
     * op-9.64~11.11: T F T F T F | 2 onload 0 onerror
     * op-12.02: T T T T T T | 2 onload 0 onerror
     * mx3.4.2:  T T T T T T | 0 onload 0 onerror
     */

    /* mobile
     * op12mini:  T T T T T T | 2 onload 0 onerror
     * ios5/sf:   T T T T T T | 0 onload 0 onerror
     * ios5/ch:   T T T T T T | 0 onload 0 onerror
     */

    function createLink(href){
        var link = document.createElement('link');
        link.rel  = 'stylesheet';
        link.type = 'text/css';
        link.href = href;
        return link;
    }
    function testFeature(event, href, callback){
        var link  = createLink(href),
            fired = false,
            allow = 2;

        link[event] = function(){
            fired = true;
        };
        insertPoint.appendChild(link);

        (function test(){
            console.log(link.sheet);
            if (fired) {
                callback(true);
                insertPoint.removeChild(link);
            } else if (allow--) {
                setTimeout(test, 0);
            } else {
                callback(false);
                insertPoint.removeChild(link);
            }
        })();
    }

    var skip = /*@cc_on!@*/!1 || '[object Opera]' === ({}).toString.call(this.opera);
    var isWebkit = 'webkitAppearance' in document.documentElement.style;

    // IE & Opera only support onload.
    var catchOnload = skip || undefined, catchOnfail = skip ? false : undefined;
    // Webkit & Gecko support onload & onerror in some new versions.
    testFeature('onload', 'none.css', function(result){
        catchOnload = result;
        log(result ? 'support onload' : 'unsupport onload');
    });
//    skip || testFeature('onerror', isWebkit ? 'data:' : 'data:,', function(result){
//        catchOnfail = result;
//        log(result ? 'support onerror' : 'unsupport onerror');
//    });
//    skip && log(catchOnload ? 'support onload' : 'unsupport onload');
//    skip && log(catchOnfail ? 'support onerror' : 'unsupport onerror');
</script>
</body>
</html>
