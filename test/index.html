<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Test: amdr.js in Browser</title>
    <link href="qunit/qunit.css" rel="stylesheet">
    <script src="qunit/qunit.js"></script>
    <script src="../src/amdr.js"></script>
    <script src="global.js"></script>
</head>
<body>
<div id="qunit"></div>
<script>
(function(){

    var config = require.config({
        urlBase: 'test/..', // fake, point to current path
        pathMap: {
            'jquery': 'http://code.jquery.com/jquery-latest.min.js',
            'foo': './foo/../', // fake, point to current path
            'bar': 'bar/..',     // fake, point to current path
            'non-1': 'non-module-1',
            'non-2': 'non-module-2'
        },
        shim: {
            'non-1': function(){
                return oNonModule1;
            },
            'non-2': function(){
                return oNonModule2;
            }
        },
        rewrite: function(name, config, pipe){
            if ('non-2' === name) {
                return 'non-1';
            }
            return name
        }
    });

    QUnit.test('require.config()', 2, function(assert){
        assert.ok('' !== config.urlBase, 'config.urlBase: ' + config.urlBase);
        assert.ok(!!config.pathMap['jquery'], 'config.pathMap');
    });

    QUnit.asyncTest('require "require"', 2, function(assert){
        require('require', function(require){
            assert.ok('function' === typeof require, 'require is function');
            assert.ok('function' === typeof require('Promise'), 'Promise is function');
        }, fallback(assert)).always(QUnit.start);
    });

    QUnit.asyncTest('require "exports"', 1, function(assert){
        require('exports', function(exports){
            assert.ok('object' === typeof exports, 'exports is object');
        }, fallback(assert)).always(QUnit.start);
    });

    QUnit.asyncTest('require "jquery"', 1, function(assert){
        require('jquery', function(){
            assert.ok(!!jQuery, 'jQuery loaded!');
        }, fallback(assert)).always(QUnit.start);
    });

    QUnit.asyncTest('require non-existent', 1, function(assert){
        require('non-existent', function(){
            // ie 6-8 will goes here.
            assert.ok(/*@cc_on!@*/!1, 'callback fired!');
        }, function(){
            assert.ok(true, 'fallback fired!');
        }).always(QUnit.start);
    });

    QUnit.asyncTest('require abs path', 1, function(assert){
        var path = location.pathname.split('/').slice(0, -1).join('/');
        require(path = path + '/bar-define.php?id=abs', function(exports){
            assert.ok('bar-abs' === exports, 'require: ' + path);
        }, fallback(assert)).always(QUnit.start);
    });

    QUnit.asyncTest('require 10 modules', 2, function(assert){
        for (var i = 0, deps = [], exps = []; i < 10; i++) {
            deps.push('foo/foo-define.php?id=' + i + '&r=' + Math.random());
            exps.push('foo-' + i + '#bar-' + i);
        }
        require(deps, function(){
            var expect = exps.join(',');
            var actual = [].join.call(arguments, ',');

            assert.ok(deps.length === arguments.length, 'args amount: ' + deps.length);
            assert.ok(expect === actual, 'exports: ' + actual);
        }, function(reason){
            assert.expect(1); assert.ok('context timeout.' === reason.message, reason);
        }).always(QUnit.start);
    });

    QUnit.asyncTest('require non-module-1 by shim', 1, function(assert){
        require(['non-1'], function(module){
            assert.deepEqual(module, { shim: 'mod-1' }, 'non: { shim: true }');
        }, fallback(assert)).always(QUnit.start);
    });

    QUnit.asyncTest('require non-module-2 rewrite to non-module-1', 1, function(assert){
        require(['non-2'], function(module){
            assert.deepEqual(module, { shim: 'mod-1' }, 'non: { shim: true }');
        }, fallback(assert)).always(QUnit.start);
    });

    function fallback(assert){ return function(reason){
        assert.expect(1); assert.ok(false, reason.message || reason);
    }; }

}());
</script>
</body>
</html>
